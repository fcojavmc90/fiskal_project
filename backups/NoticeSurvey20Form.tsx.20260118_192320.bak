"use client";

import React, { useMemo, useState } from "react";
import FiskalButton from "@/components/ui/FiskalButton";

import { generateClient } from "aws-amplify/api";
import { getCurrentUser } from "aws-amplify/auth";
import { createSurveyResponse } from "@/graphql/mutations";

type AnswerMap = Record<string, string>;

type Question = {
  id: string;
  title: string;
  options: string[];
};

const QUESTIONS: Question[] = [
  { id: "q1_letterType", title: "1. ¿Cuál es el número/tipo de carta o aviso?", options: ["CP2000", "CP14", "Letter 3219", "LTR 504", "Otro"] },
  { id: "q2_agency", title: "2. ¿Qué agencia envía la notificación?", options: ["IRS", "Estado (Florida/CA/etc.)", "Otra"] },
  { id: "q3_urgent", title: "3. ¿La notificación es urgente (fecha límite cercana)?", options: ["Sí", "No", "No sé"] },
  { id: "q4_taxYear", title: "4. ¿A qué año fiscal (Tax Year) se refiere?", options: ["2020", "2021", "2022", "2023", "Otro"] },
  { id: "q5_issueType", title: "5. ¿El aviso indica impuestos no pagados/deficiencia o corrección?", options: ["Impuestos no pagados", "Corrección/ajuste", "Multa/penalidad", "No sé"] },
  { id: "q6_amountHigh", title: "6. ¿El monto adeudado (si existe) es alto?", options: ["Bajo", "Medio", "Alto", "No aplica / No sé"] },
  { id: "q7_docsRequested", title: "7. ¿La notificación solicita documentación de respaldo?", options: ["Sí", "No", "No sé"] },
  { id: "q8_unreportedIncome", title: "8. ¿La notificación menciona ingresos no reportados?", options: ["Sí", "No", "No sé"] },
  { id: "q9_deniedDeductions", title: "9. ¿La notificación menciona deducciones/créditos rechazados?", options: ["Sí", "No", "No sé"] },
  { id: "q10_lienRisk", title: "10. ¿Hay riesgo de embargo/colección (collections/levy/lien)?", options: ["Sí", "No", "No sé"] },
  { id: "q11_returnsAccess", title: "11. ¿Tienes acceso a tus declaraciones (returns) del año indicado?", options: ["Sí", "No", "Parcial"] },
  { id: "q12_w2_1099", title: "12. ¿Tienes formularios W-2/1099 u otros respaldos?", options: ["Sí", "No", "Parcial"] },
  { id: "q13_business", title: "13. ¿Tu situación involucra negocio/LLC/self-employed?", options: ["Sí", "No", "No sé"] },
  { id: "q14_audit", title: "14. ¿El aviso menciona auditoría (audit/exam)?", options: ["Sí", "No", "No sé"] },
  { id: "q15_contacted", title: "15. ¿Ya respondiste o contactaste a la agencia?", options: ["Sí", "No", "En proceso"] },
  { id: "q16_representation", title: "16. ¿Necesitas representación profesional (CPA/EA/Attorney)?", options: ["Sí", "No", "No sé"] },
  { id: "q17_language", title: "17. ¿Prefieres atención en español o inglés?", options: ["Español", "Inglés", "Me da igual"] },
  { id: "q18_docsReady", title: "18. ¿Puedes reunir documentos dentro de 48-72 horas?", options: ["Sí", "No", "No sé"] },
  { id: "q19_state", title: "19. ¿Tu caso es federal (IRS) o estatal?", options: ["Federal (IRS)", "Estatal", "Ambos", "No sé"] },
  { id: "q20_priority", title: "20. ¿Qué es prioridad para ti ahora?", options: ["Evitar multas/embargo", "Corregir declaración", "Negociar plan de pago", "Solo entender el aviso"] },
];

const client = generateClient();

function extractGraphQLErrorMessage(err: any): string | null {
  // Amplify GraphQL errors commonly appear here:
  const msg =
    err?.errors?.[0]?.message ||
    err?.data?.errors?.[0]?.message ||
    err?.message ||
    null;
  return typeof msg === "string" ? msg : null;
}

export default function NoticeSurvey20Form() {
  const initialAnswers = useMemo<AnswerMap>(() => {
    const a: AnswerMap = {};
    for (const q of QUESTIONS) a[q.id] = "";
    return a;
  }, []);

  const [answers, setAnswers] = useState<AnswerMap>(initialAnswers);
  const [submitting, setSubmitting] = useState(false);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);
  const [okMsg, setOkMsg] = useState<string | null>(null);

  const answeredCount = useMemo(() => {
    let c = 0;
    for (const q of QUESTIONS) if ((answers[q.id] || "").trim().length > 0) c++;
    return c;
  }, [answers]);

  const progressPct = useMemo(
    () => Math.round((answeredCount / QUESTIONS.length) * 100),
    [answeredCount]
  );

  const setAnswer = (id: string, v: string) => {
    setAnswers((prev) => ({ ...prev, [id]: v }));
    setOkMsg(null);
    setErrorMsg(null);
  };

  const canSubmit = answeredCount === QUESTIONS.length && !submitting;

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setErrorMsg(null);
    setOkMsg(null);

    if (answeredCount !== QUESTIONS.length) {
      setErrorMsg("Responde las 20 preguntas para continuar.");
      return;
    }

    setSubmitting(true);
    try {
            const user = await getCurrentUser();

      const answersJson = JSON.stringify(answers);
      const safeStr = (v: any) => (v === null || v === undefined ? "" : String(v));

      // Campos del schema (inferidos desde schema.graphql en el patch)
      const REQUIRED_FIELDS = [] as const;
      const ALL_FIELDS = [] as const;

      const input: any = {};

      // Heurísticas seguras: llenamos SOLO campos existentes en el schema
      const setIfAllowed = (key: string, value: any) => {
        if (ALL_FIELDS.length === 0 || (ALL_FIELDS as readonly string[]).includes(key)) {
          input[key] = value;
        }
      };

      // valores base disponibles
      const userId = (user as any)?.userId ?? "";
      const username = (user as any)?.username ?? "";

      // 1) payload/answers json
      for (const k of ["answersJson","responsesJson","surveyJson","payload","payloadJson"]) {
        setIfAllowed(k, answersJson);
      }

      // 2) identidad
      for (const k of ["clientId","userId","owner","createdBy","professionalId"]) {
        setIfAllowed(k, safeStr(userId));
      }
      for (const k of ["email","username"]) {
        setIfAllowed(k, safeStr(username));
      }

      // 3) Si en tu archivo existe alguna variable caseId/selectedCaseId, la usamos sin romper TS
      // (si no existe, no hacemos nada)
      try {
        // @ts-ignore
        if (typeof caseId !== "undefined") setIfAllowed("caseId", safeStr(caseId));
      } catch {}
      try {
        // @ts-ignore
        if (typeof selectedCaseId !== "undefined") setIfAllowed("caseId", safeStr(selectedCaseId));
      } catch {}
      try {
        // @ts-ignore
        if (typeof currentCaseId !== "undefined") setIfAllowed("caseId", safeStr(currentCaseId));
      } catch {}

      // 4) Asegura que ningún String!/ID! requerido quede null
      for (const k of REQUIRED_FIELDS as readonly string[]) {
        if (input[k] === null || input[k] === undefined) {
          input[k] = "";
        }
      }

      await client.graphql({
        query: createSurveyResponse,
        variables: { input },
        authMode: "userPool",
      });
setOkMsg("Encuesta guardada correctamente.");
    } catch (err: any) {
      console.error("Error guardando encuesta (GraphQL):", err);
      setErrorMsg(extractGraphQLErrorMessage(err) || "Error guardando encuesta.");
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <div
        style={{
          display: "flex",
          alignItems: "flex-start",
          justifyContent: "space-between",
          gap: 16,
          flexWrap: "wrap",
        }}
      >
        <div>
          <h1
            style={{
              margin: 0,
              fontSize: 34,
              lineHeight: 1.1,
              fontWeight: 800,
              color: "var(--fiskal-blue-dark)",
            }}
          >
            Encuesta de Diagnóstico (20 preguntas)
          </h1>
          <div
            style={{
              marginTop: 8,
              color: "rgba(11, 42, 59, 0.75)",
              fontWeight: 700,
            }}
          >
            Progreso: {answeredCount}/{QUESTIONS.length}
          </div>
        </div>

        <div style={{ minWidth: 240, width: 340, maxWidth: "100%" }}>
          <div
            style={{
              height: 10,
              borderRadius: 999,
              background: "rgba(155, 201, 226, 0.35)",
              overflow: "hidden",
              border: "1px solid rgba(155, 201, 226, 0.65)",
            }}
          >
            <div
              style={{
                height: "100%",
                width: `${progressPct}%`,
                background: "var(--fiskal-blue)",
              }}
            />
          </div>
          <div
            style={{
              marginTop: 8,
              color: "rgba(11, 42, 59, 0.70)",
              fontSize: 13,
              fontWeight: 700,
            }}
          >
            {progressPct}% completado
          </div>
        </div>
      </div>

      <div
        style={{
          height: 1,
          background: "rgba(155, 201, 226, 0.55)",
          margin: "18px 0 22px",
        }}
      />

      <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
        {QUESTIONS.map((q) => (
          <div
            key={q.id}
            style={{
              padding: 14,
              borderRadius: 16,
              border: "1px solid rgba(155, 201, 226, 0.70)",
              background: "rgba(255,255,255,0.96)",
              boxShadow: "0 6px 18px rgba(11, 42, 59, 0.06)",
            }}
          >
            <div
              style={{
                fontWeight: 800,
                marginBottom: 10,
                color: "var(--fiskal-blue-dark)",
              }}
            >
              {q.title}
            </div>

            <select
              value={answers[q.id]}
              onChange={(e) => setAnswer(q.id, e.target.value)}
              style={{
                width: "100%",
                height: 46,
                borderRadius: 14,
                border: "1px solid rgba(155, 201, 226, 0.90)",
                padding: "0 12px",
                background: "white",
                outline: "none",
                fontWeight: 700,
                color: "var(--fiskal-blue-dark)",
              }}
              onFocus={(e) => {
                e.currentTarget.style.borderColor = "var(--fiskal-blue)";
                e.currentTarget.style.boxShadow = "0 0 0 4px rgba(47, 157, 187, 0.15)";
              }}
              onBlur={(e) => {
                e.currentTarget.style.borderColor = "rgba(155, 201, 226, 0.90)";
                e.currentTarget.style.boxShadow = "none";
              }}
            >
              <option value="" disabled>
                Selecciona una opción…
              </option>
              {q.options.map((opt) => (
                <option key={opt} value={opt}>
                  {opt}
                </option>
              ))}
            </select>
          </div>
        ))}
      </div>

      <div style={{ marginTop: 16 }}>
        {errorMsg ? (
          <div
            style={{
              padding: "10px 12px",
              borderRadius: 14,
              background: "rgba(242, 140, 27, 0.14)",
              color: "rgba(11, 42, 59, 0.92)",
              border: "1px solid rgba(242, 140, 27, 0.35)",
              fontWeight: 800,
            }}
          >
            {errorMsg}
          </div>
        ) : null}

        {okMsg ? (
          <div
            style={{
              padding: "10px 12px",
              borderRadius: 14,
              background: "rgba(246, 194, 28, 0.18)",
              color: "rgba(11, 42, 59, 0.92)",
              border: "1px solid rgba(246, 194, 28, 0.40)",
              fontWeight: 900,
            }}
          >
            {okMsg}
          </div>
        ) : null}
      </div>

      <div style={{ marginTop: 18, display: "flex", justifyContent: "flex-end", gap: 12 }}>
        <FiskalButton type="submit" variant="primary" disabled={!canSubmit}>
          {submitting ? "Guardando…" : "Guardar encuesta"}
        </FiskalButton>
      </div>
    </form>
  );
}
